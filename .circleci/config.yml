version: 2.1
jobs:
  build_package:
    docker:
      - image: zondax/builder-bolos:latest
    environment:
      BOLOS_SDK: /home/zondax/project/deps/nanos-secure-sdk
      BOLOS_ENV: /opt/bolos
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run:
          name: Build Baking
          environment:
            BAKING: 'yes'
          command: |
            source /home/zondax/.cargo/env
            cd /home/zondax/project
            make
      - run:
          name: Copy baking artifacts
          command: |
            mv /home/zondax/project/rust/app/pkg/installer_s.sh /home/zondax/project/rust/app/pkg/installer_baking_s.sh
            /home/zondax/go/bin/ghr -t ${GITHUB_TOKEN} \
                                    -u ${CIRCLE_PROJECT_USERNAME} \
                                    -r ${CIRCLE_PROJECT_REPONAME} \
                                    -c ${CIRCLE_SHA1} \
                                    -delete $(/home/zondax/project/rust/app/pkg/installer_baking_s.sh version) \
                                    /home/zondax/project/rust/app/pkg/installer_baking_s.sh
      - run:
          name: Build
          command: |
            source /home/zondax/.cargo/env
            cd /home/zondax/project
            make
      - run:
          name: Copy artifacts
          command: |
            /home/zondax/go/bin/ghr -t ${GITHUB_TOKEN} \
                                    -u ${CIRCLE_PROJECT_USERNAME} \
                                    -r ${CIRCLE_PROJECT_REPONAME} \
                                    -c ${CIRCLE_SHA1} \
                                    $(/home/zondax/project/rust/app/pkg/installer_s.sh version) \
                                    /home/zondax/project/rust/app/pkg/installer_s.sh

no-tags: &no-tags
  filters:
    tags:
      ignore: /.*/

workflows:
  version: 2

  default:
    jobs:
      - build_package:
          <<: *no-tags
          filters:
            branches:
              only:
                - main
